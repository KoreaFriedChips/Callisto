<!DOCTYPE html>
<html>
  <head>
    <title>Callisto</title>
    <style>
      .container {
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
      .board {
        display: grid;
        grid-template-columns: repeat(20, 1fr);
        grid-template-rows: repeat(20, 1fr);
        background-color: #000;
        width: 400px; /* Optional: Adjust the width as per your preference */
        height: 400px; /* Optional: Adjust the height as per your preference */
      }
      .cell {
        width: 20px;
        height: 20px;
        background-color: #fff;
        border: 1px solid #000; /* Add border to create grid lines */
      }
      .blue {
        background-color: blue;
      }
      .dark-blue {
        background-color: darkblue;
      }
      .piece {
        background-color: red; /* Customize the piece color as desired */
        width: 20px;
        height: 20px;
      }
      .hovering {
        background-color: rgba(
          255,
          0,
          0,
          0.5
        ); /* Customize the translucent piece color and transparency as desired */
        width: 20px;
        height: 20px;
      }
      .button-container {
        margin-top: 4rem;
      }
      .button-container button {
        margin: 1rem;
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }
      .button-container button:hover {
        background-color: #45a049;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Callisto</h1>
      <div class="board">
        {% for row in range(20) %} {% for col in range(20) %} {% if row >= 20 /
        2 - 3 and row <= 20 / 2 + 2 and col >= 20 / 2 - 3 and col <= 20 / 2 + 2
        and 20 / 2 - 1 - row + 20 / 2 - 1 - col <= 2 and 20 / 2 - 1 - row + col
        - 20 / 2 <= 2 and row - 20 / 2 + 20 / 2 - 1 - col <= 2 and row - 20 / 2
        + col - 20 / 2 <= 2 %}
        <div class="cell blue" id="{{ row }}_{{ col }}"></div>
        {% elif row + col <= 6 or (row >= 20 - 6 and col <= row - 20 + 6) or row
        + col >= 32 or (row <= 6 and col >= 13 and col - row >= 13)%}
        <div class="cell dark-blue" id="{{ row }}_{{ col }}"></div>
        {% else %}
        <div class="cell" id="{{ row }}_{{ col }}"></div>
        {% endif %} {% endfor %} {% endfor %}
      </div>
      <div class="button-container">
        <div>
          <button onclick="togglePiece('W')">W (1)</button>
          <button onclick="togglePiece('+')">+ (1)</button>
          <button onclick="togglePiece('T')">T (1)</button>
          <button onclick="togglePiece('U')">U (1)</button>
          <button onclick="togglePiece('L')">L (2)</button>
          <button onclick="togglePiece('Short T')">Short T (2)</button>
          <button onclick="togglePiece('Z')">Z (2)</button>
          <button onclick="togglePiece('Square')">Square (2)</button>
          <button onclick="togglePiece('Turn')">Turn (2)</button>
          <button onclick="togglePiece('1x2')">1x2 (2)</button>
          <button onclick="togglePiece('1x3')">1x3 (2)</button>
          <button onclick="togglePiece('New Base')">New Base (3)</button>
        </div>
        <div>
          <button onclick="rotateRight()">Rotate Right ↻</button>
          <button onclick="rotateLeft()">Rotate Left ↺</button>
        </div>
      </div>
    </div>
    <script>
      // pieces: type of piece, show, #
      let pieces = [
        ["W", false, 1],
        ["+", false, 1],
        ["T", false, 1],
        ["U", false, 1],
        ["L", false, 2],
        ["Short T", false, 2],
        ["Z", false, 2],
        ["Square", false, 2],
        ["Turn", false, 2],
        ["1x2", false, 2],
        ["1x3", false, 2],
        ["New Base", true, 3],
      ];
      function togglePiece(name) {
        pieces.forEach(([piece, show, val], index) => {
          pieces[index][1] = piece === name;
        });
      }
      function getPieceShape(piece, rotation, centerX, centerY) {
        const cellsAround = [
          [
            document.getElementById(`${centerX - 1}_${centerY - 1}`), // top left
            document.getElementById(`${centerX - 1}_${centerY}`), // top mid
            document.getElementById(`${centerX - 1}_${centerY + 1}`), // top right
          ],
          [
            document.getElementById(`${centerX}_${centerY - 1}`), // mid left
            null,
            document.getElementById(`${centerX}_${centerY + 1}`), // mid right
          ],
          [
            document.getElementById(`${centerX + 1}_${centerY - 1}`), // bot left
            document.getElementById(`${centerX + 1}_${centerY}`), // bot mid
            document.getElementById(`${centerX + 1}_${centerY + 1}`), // bot right
          ],
        ];

        // rotate 90 degrees clockwise, selecting same squares so technically counterclock-wise
        const N = 3;
        for (let r = 0; r < rotate; r++) {
          for (i = 0; i < parseInt(N / 2); i++) {
            for (j = i; j < N - i - 1; j++) {
              // Swap elements of each cycle
              // in clockwise direction
              var temp = cellsAround[i][j];
              cellsAround[i][j] = cellsAround[N - 1 - j][i];
              cellsAround[N - 1 - j][i] = cellsAround[N - 1 - i][N - 1 - j];
              cellsAround[N - 1 - i][N - 1 - j] = cellsAround[j][N - 1 - i];
              cellsAround[j][N - 1 - i] = temp;
            }
          }
        }

        let cellShape = [];
        switch (piece) {
          case "W":
            cellShape = [
              cellsAround[0][0],
              cellsAround[1][0],
              cellsAround[2][1],
              cellsAround[2][2],
            ];
            break;
          case "+":
            cellShape = [
              cellsAround[0][1],
              cellsAround[1][0],
              cellsAround[1][2],
              cellsAround[2][1],
            ];
            break;
          case "T":
            cellShape = [
              cellsAround[0][0],
              cellsAround[0][1],
              cellsAround[0][2],
              cellsAround[2][1],
            ];
            break;
          case "U":
            cellShape = [
              cellsAround[0][0],
              cellsAround[1][0],
              cellsAround[1][2],
              cellsAround[0][2],
            ];
            break;
          case "L":
            cellShape = [
              cellsAround[0][1],
              cellsAround[2][1],
              cellsAround[2][2],
            ];
            break;
          case "Short T":
            cellShape = [
              cellsAround[1][0],
              cellsAround[1][2],
              cellsAround[2][1],
            ];
            break;
          case "Z":
            cellShape = [
              cellsAround[1][0],
              cellsAround[2][1],
              cellsAround[2][2],
            ];
            break;
          case "Square":
            cellShape = [
              cellsAround[1][0],
              cellsAround[2][0],
              cellsAround[2][1],
            ];
            break;
          case "Turn":
            cellShape = [cellsAround[0][1], cellsAround[1][2]];
            break;
          case "1x2":
            cellShape = [cellsAround[0][1], cellsAround[2][1]];
            break;
          case "1x3":
            cellShape = [cellsAround[1][0]];
            break;
          case "New Base":
            break;
          default:
            null;
        }

        return cellShape;
      }

      let rotate = 0;
      function rotateRight() {
        rotate--;
        if (rotate < 0) rotate = 3;
      }
      function rotateLeft() {
        rotate = (rotate + 1) % 4;
      }

      const cells = document.querySelectorAll(".cell");
      let isPlacingPiece = false;

      function highlightCellAndSurrounding(cell) {
        const [centerX, centerY] = cell.id.split("_").map(Number);
        let cellShape = [];
        pieces.forEach(([piece, show, val]) => {
          if (show && val) {
            cellShape = getPieceShape(piece, rotate, centerX, centerY);
          } else if (show && !val) {
            //notification that u used all these pieces already
          }
        });
        const isHovering = document.createElement("div");
        const hoverId = "hover_" + cell.id; // Unique identifier for each hover element
        isHovering.classList.add("hovering");
        isHovering.setAttribute("data-hover-id", hoverId);
        cell.appendChild(isHovering);
        cellShape.forEach((cell) => {
          if (cell) {
            const hoverDiv = document.createElement("div");
            hoverDiv.classList.add("hovering");
            hoverDiv.setAttribute("data-hover-id", hoverId);
            cell.appendChild(hoverDiv);
          }
        });
      }

      function removeHighlightFromCellAndSurrounding(cell) {
        const hoverId = "hover_" + cell.id; // Get the unique identifier for the hover element
        const hoverElements = document.querySelectorAll(
          `[data-hover-id="${hoverId}"]`
        );

        hoverElements.forEach((hoverElement) => {
          if (hoverElement && hoverElement.parentNode) {
            hoverElement.parentNode.removeChild(hoverElement);
          }
        });
      }

      function checkPlayable(cellShape) {
        // check it is touching another cell that is already placed
        // check it is not on outer blue or out of bounds
        // check it is not on top of another placed piece
        let adjacent = false,
          outOfBounds = false,
          onTop = false;

        if (cellShape.length === 1) adjacent = true;
        for (const cell of cellShape) {
          if (!cell || cell.classList.contains("dark-blue")) {
            outOfBounds = true;
            break;
          }
          if (cell.classList.contains("piece")) {
            onTop = true;
            break;
          }
          const [centerX, centerY] = cell.id.split("_").map(Number);
          const surroundingCells = [
            document.getElementById(`${centerX - 1}_${centerY}`), // top mid
            document.getElementById(`${centerX}_${centerY - 1}`), // mid left
            document.getElementById(`${centerX}_${centerY + 1}`), // mid right
            document.getElementById(`${centerX + 1}_${centerY}`), // bot mid
          ];
          for (const surroundingCell of surroundingCells) {
            if (
              surroundingCell &&
              surroundingCell.classList.contains("piece")
            ) {
              adjacent = true;
            }
          }
        }
        return adjacent && !outOfBounds && !onTop;
      }

      function placePiece(cell) {
        const hoverId = "hover_" + cell.id; // Get the unique identifier for the hover element
        const hoverElements = document.querySelectorAll(
          `[data-hover-id="${hoverId}"]`
        );

        hoverElements.forEach((hoverElement) => {
          if (hoverElement && hoverElement.parentNode) {
            hoverElement.parentNode.removeChild(hoverElement);
            hoverElement.classList.add("piece");
            isPlacingPiece = true;
          }
        });
        isPlacingPiece = false;
      }

      function updateButtonLabels() {
        const buttons = document.querySelectorAll(".button-container button");
        buttons.forEach((button, index) => {
          button.textContent = `${pieces[index][0]}` + ` (${pieces[index][2]})`;
        });
      }

      cells.forEach((cell) => {
        cell.addEventListener("mouseenter", () => {
          // console.log("enter: " + cell.id);
          if (!isPlacingPiece && !cell.classList.contains("piece")) {
            highlightCellAndSurrounding(cell);
          }
        });

        cell.addEventListener("mouseleave", () => {
          if (isPlacingPiece) {
            return;
          }
          removeHighlightFromCellAndSurrounding(cell);
        });

        cell.addEventListener("click", () => {
          if (!isPlacingPiece && !cell.classList.contains("piece")) {
            const [centerX, centerY] = cell.id.split("_").map(Number);
            let cellShape = [];
            pieces.forEach(([piece, show, val], index) => {
              if (show) {
                cellShape = getPieceShape(piece, rotate, centerX, centerY);
              }
            });
            cellShape.push(cell);
            if (checkPlayable(cellShape)) {
              cellShape.forEach((cell) => {
                if (cell) {
                  cell.classList.add("piece");
                }
              });
              pieces.forEach(([piece, show, val], index) => {
                if (show) {
                  pieces[index][2]--;
                  updateButtonLabels();
                }
              });
            }
          }
        });
      });
    </script>
  </body>
</html>
